#include <gtest/gtest.h>

#include "chkdskparserfixture.h"

using namespace std;

namespace
{
   LogicalDrive BuildDrive(const wstring& name, const wstring& totalSpace,
                           const wstring& freeSpace, const wstring& badSectors)
   {
      LogicalDrive drive;
      drive.name = name;
      drive.totalSpace = totalSpace;
      drive.freeSpace = freeSpace;
      drive.badSectors = badSectors;
      return drive;
   }
}

TEST_F(ChkdskParserFixture, doesnt_crash_when_parsing_invalid_buffer)
{
   TestNoCrashOnInvalidBuffer();
}

TEST_F(ChkdskParserFixture, creates_one_drive_report)
{
   const wstring buffer = L"The type of the file system is NTFS.\n"
                          L"\n"
                          L"WARNING!  F parameter not specified.\n"
                          L"Running CHKDSK in read-only mode.\n"
                          L"\n"
                          L"CHKDSK is verifying files (stage 1 of 3)...\n"
                          L" 0 percent complete. (0 of 393984 file records processed)     \n"
                          L" 0 percent complete. (4353 of 393984 file records processed)     \n"
                          L" 0 percent complete. (18909 of 393984 file records processed)     \n"
                          L" 0 percent complete. (22273 of 393984 file records processed)     \n"
                          L" 0 percent complete. (30787 of 393984 file records processed)     \n"
                          L" 0 percent complete. (31251 of 393984 file records processed)     \n"
                          L" 1 percent complete. (39399 of 393984 file records processed)     \n"
                          L" 1 percent complete. (43245 of 393984 file records processed)     \n"
                          L" 1 percent complete. (52737 of 393984 file records processed)     \n"
                          L" 1 percent complete. (67585 of 393984 file records processed)     \n"
                          L" 1 percent complete. (73473 of 393984 file records processed)     \n"
                          L" 2 percent complete. (78797 of 393984 file records processed)     \n"
                          L" 2 percent complete. (91649 of 393984 file records processed)     \n"
                          L" 2 percent complete. (113409 of 393984 file records processed)     \n"
                          L" 3 percent complete. (118196 of 393984 file records processed)     \n"
                          L" 3 percent complete. (147969 of 393984 file records processed)     \n"
                          L" 4 percent complete. (157594 of 393984 file records processed)     \n"
                          L" 4 percent complete. (168284 of 393984 file records processed)     \n"
                          L" 4 percent complete. (173825 of 393984 file records processed)     \n"
                          L" 4 percent complete. (186881 of 393984 file records processed)     \n"
                          L" 4 percent complete. (196705 of 393984 file records processed)     \n"
                          L" 5 percent complete. (196992 of 393984 file records processed)     \n"
                          L" 5 percent complete. (233985 of 393984 file records processed)     \n"
                          L" 6 percent complete. (236391 of 393984 file records processed)     \n"
                          L" 6 percent complete. (248528 of 393984 file records processed)     \n"
                          L" 6 percent complete. (263169 of 393984 file records processed)     \n"
                          L" 7 percent complete. (275789 of 393984 file records processed)     \n"
                          L" 7 percent complete. (295169 of 393984 file records processed)     \n"
                          L" 8 percent complete. (315188 of 393984 file records processed)     \n"
                          L" 9 percent complete. (354586 of 393984 file records processed)     \n"
                          L"  393984 file records processed.                                         \n"
                          L"\n"
                          L"File verification completed.\n"
                          L"  3010 large file records processed.                                   \n"
                          L"\n"
                          L"  0 bad file records processed.                                     \n"
                          L"\n"
                          L"  2 EA records processed.                                           \n"
                          L"\n"
                          L"  47 reparse records processed.                                      \n"
                          L"\n"
                          L"CHKDSK is verifying indexes (stage 2 of 3)...\n"
                          L"11 percent complete. (6909 of 497126 index entries processed)    \n"
                          L"12 percent complete. (14838 of 497126 index entries processed)    \n"
                          L"13 percent complete. (22767 of 497126 index entries processed)    \n"
                          L"14 percent complete. (30695 of 497126 index entries processed)    \n"
                          L"15 percent complete. (38624 of 497126 index entries processed)    \n"
                          L"16 percent complete. (46553 of 497126 index entries processed)    \n"
                          L"17 percent complete. (54481 of 497126 index entries processed)    \n"
                          L"18 percent complete. (62410 of 497126 index entries processed)    \n"
                          L"19 percent complete. (70338 of 497126 index entries processed)    \n"
                          L"20 percent complete. (78267 of 497126 index entries processed)    \n"
                          L"21 percent complete. (86196 of 497126 index entries processed)    \n"
                          L"22 percent complete. (94124 of 497126 index entries processed)    \n"
                          L"23 percent complete. (102053 of 497126 index entries processed)    \n"
                          L"24 percent complete. (109982 of 497126 index entries processed)    \n"
                          L"25 percent complete. (117910 of 497126 index entries processed)    \n"
                          L"26 percent complete. (125839 of 497126 index entries processed)    \n"
                          L"27 percent complete. (133767 of 497126 index entries processed)    \n"
                          L"28 percent complete. (141696 of 497126 index entries processed)    \n"
                          L"29 percent complete. (149625 of 497126 index entries processed)    \n"
                          L"30 percent complete. (157553 of 497126 index entries processed)    \n"
                          L"31 percent complete. (165482 of 497126 index entries processed)    \n"
                          L"32 percent complete. (173411 of 497126 index entries processed)    \n"
                          L"33 percent complete. (181339 of 497126 index entries processed)    \n"
                          L"34 percent complete. (189268 of 497126 index entries processed)    \n"
                          L"35 percent complete. (197196 of 497126 index entries processed)    \n"
                          L"36 percent complete. (205125 of 497126 index entries processed)    \n"
                          L"37 percent complete. (213054 of 497126 index entries processed)    \n"
                          L"38 percent complete. (220982 of 497126 index entries processed)    \n"
                          L"39 percent complete. (228911 of 497126 index entries processed)    \n"
                          L"40 percent complete. (236839 of 497126 index entries processed)    \n"
                          L"41 percent complete. (244768 of 497126 index entries processed)    \n"
                          L"42 percent complete. (252697 of 497126 index entries processed)    \n"
                          L"43 percent complete. (260625 of 497126 index entries processed)    \n"
                          L"44 percent complete. (268554 of 497126 index entries processed)    \n"
                          L"45 percent complete. (276483 of 497126 index entries processed)    \n"
                          L"46 percent complete. (284411 of 497126 index entries processed)    \n"
                          L"47 percent complete. (292340 of 497126 index entries processed)    \n"
                          L"48 percent complete. (300268 of 497126 index entries processed)    \n"
                          L"49 percent complete. (308197 of 497126 index entries processed)    \n"
                          L"50 percent complete. (316126 of 497126 index entries processed)    \n"
                          L"51 percent complete. (324054 of 497126 index entries processed)    \n"
                          L"52 percent complete. (331983 of 497126 index entries processed)    \n"
                          L"53 percent complete. (339912 of 497126 index entries processed)    \n"
                          L"54 percent complete. (347840 of 497126 index entries processed)    \n"
                          L"55 percent complete. (355769 of 497126 index entries processed)    \n"
                          L"56 percent complete. (363697 of 497126 index entries processed)    \n"
                          L"57 percent complete. (371626 of 497126 index entries processed)    \n"
                          L"58 percent complete. (379555 of 497126 index entries processed)    \n"
                          L"59 percent complete. (387483 of 497126 index entries processed)    \n"
                          L"59 percent complete. (394563 of 497126 index entries processed)    \n"
                          L"60 percent complete. (395412 of 497126 index entries processed)    \n"
                          L"60 percent complete. (395940 of 497126 index entries processed)    \n"
                          L"60 percent complete. (396419 of 497126 index entries processed)    \n"
                          L"60 percent complete. (396992 of 497126 index entries processed)    \n"
                          L"60 percent complete. (397274 of 497126 index entries processed)    \n"
                          L"60 percent complete. (397903 of 497126 index entries processed)    \n"
                          L"60 percent complete. (400745 of 497126 index entries processed)    \n"
                          L"61 percent complete. (403341 of 497126 index entries processed)    \n"
                          L"61 percent complete. (405911 of 497126 index entries processed)    \n"
                          L"61 percent complete. (405916 of 497126 index entries processed)    \n"
                          L"61 percent complete. (407794 of 497126 index entries processed)    \n"
                          L"61 percent complete. (409778 of 497126 index entries processed)    \n"
                          L"61 percent complete. (411124 of 497126 index entries processed)    \n"
                          L"62 percent complete. (411269 of 497126 index entries processed)    \n"
                          L"62 percent complete. (411609 of 497126 index entries processed)    \n"
                          L"62 percent complete. (411648 of 497126 index entries processed)    \n"
                          L"62 percent complete. (412058 of 497126 index entries processed)    \n"
                          L"62 percent complete. (412866 of 497126 index entries processed)    \n"
                          L"62 percent complete. (413754 of 497126 index entries processed)    \n"
                          L"62 percent complete. (413835 of 497126 index entries processed)    \n"
                          L"62 percent complete. (414424 of 497126 index entries processed)    \n"
                          L"62 percent complete. (416349 of 497126 index entries processed)    \n"
                          L"62 percent complete. (418451 of 497126 index entries processed)    \n"
                          L"62 percent complete. (418931 of 497126 index entries processed)    \n"
                          L"62 percent complete. (419142 of 497126 index entries processed)    \n"
                          L"63 percent complete. (419198 of 497126 index entries processed)    \n"
                          L"63 percent complete. (419308 of 497126 index entries processed)    \n"
                          L"63 percent complete. (419473 of 497126 index entries processed)    \n"
                          L"63 percent complete. (419812 of 497126 index entries processed)    \n"
                          L"63 percent complete. (420028 of 497126 index entries processed)    \n"
                          L"63 percent complete. (420300 of 497126 index entries processed)    \n"
                          L"63 percent complete. (420540 of 497126 index entries processed)    \n"
                          L"63 percent complete. (420602 of 497126 index entries processed)    \n"
                          L"63 percent complete. (420921 of 497126 index entries processed)    \n"
                          L"63 percent complete. (421524 of 497126 index entries processed)    \n"
                          L"63 percent complete. (421877 of 497126 index entries processed)    \n"
                          L"63 percent complete. (422083 of 497126 index entries processed)    \n"
                          L"63 percent complete. (422279 of 497126 index entries processed)    \n"
                          L"63 percent complete. (422584 of 497126 index entries processed)    \n"
                          L"63 percent complete. (422684 of 497126 index entries processed)    \n"
                          L"63 percent complete. (422842 of 497126 index entries processed)    \n"
                          L"63 percent complete. (422946 of 497126 index entries processed)    \n"
                          L"63 percent complete. (423058 of 497126 index entries processed)    \n"
                          L"63 percent complete. (423111 of 497126 index entries processed)    \n"
                          L"63 percent complete. (423233 of 497126 index entries processed)    \n"
                          L"63 percent complete. (423467 of 497126 index entries processed)    \n"
                          L"63 percent complete. (423681 of 497126 index entries processed)    \n"
                          L"63 percent complete. (423975 of 497126 index entries processed)    \n"
                          L"63 percent complete. (424258 of 497126 index entries processed)    \n"
                          L"63 percent complete. (424954 of 497126 index entries processed)    \n"
                          L"63 percent complete. (425585 of 497126 index entries processed)    \n"
                          L"63 percent complete. (425888 of 497126 index entries processed)    \n"
                          L"63 percent complete. (426167 of 497126 index entries processed)    \n"
                          L"63 percent complete. (426342 of 497126 index entries processed)    \n"
                          L"63 percent complete. (426505 of 497126 index entries processed)    \n"
                          L"63 percent complete. (426683 of 497126 index entries processed)    \n"
                          L"63 percent complete. (426875 of 497126 index entries processed)    \n"
                          L"64 percent complete. (427126 of 497126 index entries processed)    \n"
                          L"64 percent complete. (427406 of 497126 index entries processed)    \n"
                          L"64 percent complete. (427760 of 497126 index entries processed)    \n"
                          L"64 percent complete. (428065 of 497126 index entries processed)    \n"
                          L"64 percent complete. (428472 of 497126 index entries processed)    \n"
                          L"64 percent complete. (428820 of 497126 index entries processed)    \n"
                          L"64 percent complete. (428987 of 497126 index entries processed)    \n"
                          L"64 percent complete. (429153 of 497126 index entries processed)    \n"
                          L"64 percent complete. (429318 of 497126 index entries processed)    \n"
                          L"64 percent complete. (429436 of 497126 index entries processed)    \n"
                          L"64 percent complete. (429851 of 497126 index entries processed)    \n"
                          L"64 percent complete. (431037 of 497126 index entries processed)    \n"
                          L"64 percent complete. (431809 of 497126 index entries processed)    \n"
                          L"64 percent complete. (432252 of 497126 index entries processed)    \n"
                          L"64 percent complete. (432888 of 497126 index entries processed)    \n"
                          L"64 percent complete. (433368 of 497126 index entries processed)    \n"
                          L"64 percent complete. (433897 of 497126 index entries processed)    \n"
                          L"64 percent complete. (433995 of 497126 index entries processed)    \n"
                          L"64 percent complete. (434238 of 497126 index entries processed)    \n"
                          L"64 percent complete. (434387 of 497126 index entries processed)    \n"
                          L"64 percent complete. (434578 of 497126 index entries processed)    \n"
                          L"64 percent complete. (434835 of 497126 index entries processed)    \n"
                          L"65 percent complete. (435055 of 497126 index entries processed)    \n"
                          L"65 percent complete. (435527 of 497126 index entries processed)    \n"
                          L"65 percent complete. (435762 of 497126 index entries processed)    \n"
                          L"65 percent complete. (435930 of 497126 index entries processed)    \n"
                          L"65 percent complete. (436276 of 497126 index entries processed)    \n"
                          L"65 percent complete. (436439 of 497126 index entries processed)    \n"
                          L"65 percent complete. (436687 of 497126 index entries processed)    \n"
                          L"65 percent complete. (436951 of 497126 index entries processed)    \n"
                          L"65 percent complete. (437224 of 497126 index entries processed)    \n"
                          L"65 percent complete. (437539 of 497126 index entries processed)    \n"
                          L"65 percent complete. (437869 of 497126 index entries processed)    \n"
                          L"65 percent complete. (438037 of 497126 index entries processed)    \n"
                          L"65 percent complete. (438794 of 497126 index entries processed)    \n"
                          L"65 percent complete. (439010 of 497126 index entries processed)    \n"
                          L"65 percent complete. (439572 of 497126 index entries processed)    \n"
                          L"65 percent complete. (440296 of 497126 index entries processed)    \n"
                          L"65 percent complete. (440516 of 497126 index entries processed)    \n"
                          L"65 percent complete. (440793 of 497126 index entries processed)    \n"
                          L"65 percent complete. (441091 of 497126 index entries processed)    \n"
                          L"65 percent complete. (441424 of 497126 index entries processed)    \n"
                          L"65 percent complete. (441852 of 497126 index entries processed)    \n"
                          L"65 percent complete. (442156 of 497126 index entries processed)    \n"
                          L"65 percent complete. (442312 of 497126 index entries processed)    \n"
                          L"65 percent complete. (442590 of 497126 index entries processed)    \n"
                          L"65 percent complete. (442824 of 497126 index entries processed)    \n"
                          L"66 percent complete. (442984 of 497126 index entries processed)    \n"
                          L"66 percent complete. (443231 of 497126 index entries processed)    \n"
                          L"66 percent complete. (443511 of 497126 index entries processed)    \n"
                          L"66 percent complete. (443631 of 497126 index entries processed)    \n"
                          L"66 percent complete. (443756 of 497126 index entries processed)    \n"
                          L"66 percent complete. (443879 of 497126 index entries processed)    \n"
                          L"66 percent complete. (443998 of 497126 index entries processed)    \n"
                          L"66 percent complete. (444300 of 497126 index entries processed)    \n"
                          L"66 percent complete. (444406 of 497126 index entries processed)    \n"
                          L"66 percent complete. (444553 of 497126 index entries processed)    \n"
                          L"66 percent complete. (444782 of 497126 index entries processed)    \n"
                          L"66 percent complete. (444963 of 497126 index entries processed)    \n"
                          L"66 percent complete. (445096 of 497126 index entries processed)    \n"
                          L"66 percent complete. (445433 of 497126 index entries processed)    \n"
                          L"  497126 index entries processed.                                        \n"
                          L"\n"
                          L"Index verification completed.\n"
                          L"  0 unindexed files scanned.                                        \n"
                          L"\n"
                          L"  0 unindexed files recovered.                                      \n"
                          L"\n"
                          L"CHKDSK is verifying security descriptors (stage 3 of 3)...\n"
                          L"73 percent complete. (4073 of 393984 file SDs/SIDs processed)    \n"
                          L"74 percent complete. (27859 of 393984 file SDs/SIDs processed)    \n"
                          L"75 percent complete. (51645 of 393984 file SDs/SIDs processed)    \n"
                          L"76 percent complete. (75431 of 393984 file SDs/SIDs processed)    \n"
                          L"77 percent complete. (99217 of 393984 file SDs/SIDs processed)    \n"
                          L"78 percent complete. (123002 of 393984 file SDs/SIDs processed)    \n"
                          L"79 percent complete. (146788 of 393984 file SDs/SIDs processed)    \n"
                          L"80 percent complete. (170574 of 393984 file SDs/SIDs processed)    \n"
                          L"81 percent complete. (194360 of 393984 file SDs/SIDs processed)    \n"
                          L"82 percent complete. (218146 of 393984 file SDs/SIDs processed)    \n"
                          L"83 percent complete. (241932 of 393984 file SDs/SIDs processed)    \n"
                          L"84 percent complete. (265718 of 393984 file SDs/SIDs processed)    \n"
                          L"85 percent complete. (289503 of 393984 file SDs/SIDs processed)    \n"
                          L"86 percent complete. (313289 of 393984 file SDs/SIDs processed)    \n"
                          L"87 percent complete. (337075 of 393984 file SDs/SIDs processed)    \n"
                          L"88 percent complete. (360861 of 393984 file SDs/SIDs processed)    \n"
                          L"89 percent complete. (384647 of 393984 file SDs/SIDs processed)    \n"
                          L"  393984 file SDs/SIDs processed.                                        \n"
                          L"\n"
                          L"Security descriptor verification completed.\n"
                          L"  51572 data files processed.                                           \n"
                          L"\n"
                          L"CHKDSK is verifying Usn Journal...\n"
                          L"99 percent complete. (0 of 37221600 USN bytes processed)        \n"
                          L"100 percent complete. (37216256 of 37221600 USN bytes processed)        \n"
                          L"  37221600 USN bytes processed.                                            \n"
                          L"\n"
                          L"Usn Journal verification completed.\n"
                          L"Windows has checked the file system and found no problems.\n"
                          L"\n"
                          L" 102294527 KB total disk space.\n"
                          L"  80691208 KB in 314586 files.\n"
                          L"    178276 KB in 51573 indexes.\n"
                          L"         0 KB in bad sectors.\n"
                          L"    502079 KB in use by the system.\n"
                          L"     65536 KB occupied by the log file.\n"
                          L"  20922964 KB available on disk.\n"
                          L"\n"
                          L"      4096 bytes in each allocation unit.\n"
                          L"  25573631 total allocation units on disk.\n"
                          L"   5230741 allocation units available on disk.\n";


   const wstring expectedMiniReport = L"drive OK";
   const wstring expectedFullReport = L"Drive C:"
                                      L"\tTotal Space : 97.56 Gb\n"
                                      L"\tFree Space : 19.9 Gb\n"
                                      L"\tBad Sectors : 0.00 bytes\n";

   LogicalDrive expectedDrive = BuildDrive(L"", L"97.56 Gb", L"19.9 Gb", L"0.00 bytes");
   TestParseOk(buffer, {expectedDrive}, expectedMiniReport, expectedFullReport);
}

TEST_F(ChkdskParserFixture, creates_multiple_drive_report)
{
   const wstring buffer = L"dummy buffer";
   const wstring expectedMiniReport = L"2 drives OK";
   const wstring expectedFullReport = L"Drive C:"
                                      L"\tTotal Space : 97.5 Gb\n"
                                      L"\tFree Space : 19.9 Gb\n"
                                      L"\tBad Sectors : 0 Kb\n"
                                      L"Drive D:"
                                      L"\tTotal Space : 97.5 Gb\n"
                                      L"\tFree Space : 19.9 Gb\n"
                                      L"\tBad Sectors : 0 Kb\n";

   vector<LogicalDrive> expectedDrives;
   expectedDrives.push_back(BuildDrive(L"C", L"97.5 Gb", L"19.9 Gb", L"0"));
   expectedDrives.push_back(BuildDrive(L"D", L"97.5 Gb", L"19.9 Gb", L"0"));
   TestParseOk(buffer, expectedDrives, expectedMiniReport, expectedFullReport);
}
